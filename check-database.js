#!/usr/bin/env node

/**
 * ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL Ø¹Ù„Ù‰ Render.com
 */

import { Pool } from 'pg';
import dotenv from 'dotenv';

dotenv.config();

const pool = new Pool({
    host: process.env.DB_HOST || 'dpg-d26hc33uibrs739skhdg-a.frankfurt-postgres.render.com',
    port: process.env.DB_PORT || 5432,
    database: process.env.DB_NAME || 'shaababna_db',
    user: process.env.DB_USER || 'shaababna_db_user',
    password: process.env.DB_PASSWORD || 'vqvaeTyJS1qD1NVwurk8knW1GnUoRCna',
    ssl: {
        rejectUnauthorized: false
    }
});

console.log('ğŸ” ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL...\n');

async function checkDatabase() {
    try {
        const client = await pool.connect();
        console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

        // ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const tablesResult = await client.query(`
            SELECT table_name
            FROM information_schema.tables
            WHERE table_schema = 'public'
            ORDER BY table_name
        `);

        console.log('\nğŸ“‹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:');
        if (tablesResult.rows.length === 0) {
            console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        } else {
            tablesResult.rows.forEach(row => {
                console.log(`   âœ… ${row.table_name}`);
            });
        }

        // ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙ„ Ø¬Ø¯ÙˆÙ„
        const tables = ['users', 'events', 'programs', 'blogs', 'contact_forms', 'join_requests'];

        for (const table of tables) {
            try {
                const countResult = await client.query(`SELECT COUNT(*) FROM ${table}`);
                const count = countResult.rows[0].count;
                console.log(`   ğŸ“Š ${table}: ${count} ØµÙ`);

                if (count > 0) {
                    const sampleResult = await client.query(`SELECT * FROM ${table} LIMIT 1`);
                    console.log(`   ğŸ“ Ø¹ÙŠÙ†Ø©: ${JSON.stringify(sampleResult.rows[0], null, 2)}`);
                }
            } catch (error) {
                console.log(`   âŒ ${table}: Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
            }
        }

        client.release();
        console.log('\nğŸ‰ ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªÙ…Ù„!');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error.message);
    } finally {
        await pool.end();
    }
}

checkDatabase().catch(console.error);