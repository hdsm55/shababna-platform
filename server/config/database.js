import { Pool } from 'pg';
import dotenv from 'dotenv';

// ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
dotenv.config();

// Ø¥Ù†Ø´Ø§Ø¡ pool Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
const pool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    database: process.env.DB_NAME || 'shababna',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || '',
    max: 25, // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
    min: 2, // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª
    idleTimeoutMillis: 60000, // Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
    connectionTimeoutMillis: 15000, // Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø§ØªØµØ§Ù„
    acquireTimeoutMillis: 30000, // ÙˆÙ‚Øª Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„
    ssl: {
        rejectUnauthorized: false,
        require: true
    }
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
pool.on('error', (err) => {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ pool Ø§Ù„Ø§ØªØµØ§Ù„:', err);
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø§ØªØµØ§Ù„
pool.on('connect', (client) => {
    console.log('ðŸ”— ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
pool.on('remove', (client) => {
    console.log('ðŸ”Œ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
});

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
export const testConnection = async (retries = 5) => {
    for (let i = 0; i < retries; i++) {
        try {
            const client = await pool.connect();
            const result = await client.query('SELECT NOW()');
            client.release();
            console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL Ø¨Ù†Ø¬Ø§Ø­:', result.rows[0]);
            return true;
        } catch (error) {
            console.error(`âŒ Ù…Ø­Ø§ÙˆÙ„Ø© ${i + 1}/${retries} - Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL:`, error.message);
            if (i === retries - 1) return false;
            // Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ²Ø§ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            const waitTime = Math.min(1000 * Math.pow(2, i), 5000);
            await new Promise(resolve => setTimeout(resolve, waitTime));
        }
    }
    return false;
};

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
export const query = async (text, params = [], retries = 5) => {
    for (let i = 0; i < retries; i++) {
        try {
            const result = await pool.query(text, params);
            return result;
        } catch (error) {
            console.error(`âŒ Ù…Ø­Ø§ÙˆÙ„Ø© ${i + 1}/${retries} - Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…:`, error.message);
            if (i === retries - 1) throw error;
            // Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ²Ø§ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            const waitTime = Math.min(1000 * Math.pow(2, i), 3000);
            await new Promise(resolve => setTimeout(resolve, waitTime));
        }
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
export const getRows = async (text, params = [], retries = 5) => {
    for (let i = 0; i < retries; i++) {
        try {
            const result = await pool.query(text, params);
            return result.rows;
        } catch (error) {
            console.error(`âŒ Ù…Ø­Ø§ÙˆÙ„Ø© ${i + 1}/${retries} - Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:`, error.message);
            if (i === retries - 1) throw error;
            // Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ²Ø§ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            const waitTime = Math.min(1000 * Math.pow(2, i), 3000);
            await new Promise(resolve => setTimeout(resolve, waitTime));
        }
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
export const getRow = async (text, params = [], retries = 5) => {
    for (let i = 0; i < retries; i++) {
        try {
            const result = await pool.query(text, params);
            return result.rows[0] || null;
        } catch (error) {
            console.error(`âŒ Ù…Ø­Ø§ÙˆÙ„Ø© ${i + 1}/${retries} - Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙ:`, error.message);
            if (i === retries - 1) throw error;
            // Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ²Ø§ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            const waitTime = Math.min(1000 * Math.pow(2, i), 3000);
            await new Promise(resolve => setTimeout(resolve, waitTime));
        }
    }
};

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
export const closePool = async () => {
    await pool.end();
};

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ client
export const getClient = () => pool.connect();

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Pool
export const getPoolStats = () => {
    return {
        totalCount: pool.totalCount,
        idleCount: pool.idleCount,
        waitingCount: pool.waitingCount
    };
};

export { pool };
export default pool;