# دليل إعداد نظام إعادة تعيين كلمة المرور

## الخطوات المطلوبة للإعداد

### 1. إعداد حساب Resend

1. **إنشاء حساب Resend**:

   - اذهب إلى [resend.com](https://resend.com)
   - أنشئ حساب جديد أو سجل الدخول
   - اذهب إلى صفحة API Keys

2. **إنشاء API Key**:

   - انقر على "Create API Key"
   - اختر اسم مناسب مثل "shababna-password-reset"
   - انسخ المفتاح (يبدأ بـ `re_`)

3. **إعداد النطاق** (اختياري لكن مُوصى به):
   - أضف نطاقك إلى Resend
   - اتبع التعليمات للتحقق من النطاق
   - هذا يحسن من معدل التسليم

### 2. تحديث متغيرات البيئة

أضف المتغيرات التالية إلى ملف `.env`:

```env
# Resend Email Service
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx
SENDER_EMAIL=info@shaababna.com
SENDER_NAME=منظمة شبابنا العالمية
RESET_LINK_BASE=https://shaababna.com/reset-password
TOKEN_TTL_MINUTES=60
```

**ملاحظات مهمة**:

- استبدل `re_xxxxxxxxxxxxxxxxxxxxx` بمفتاح Resend الفعلي
- البريد الإلكتروني `info@shaababna.com` هو البريد الرسمي للمؤسسة
- استبدل `https://shaababna.com` بالرابط الفعلي لموقعك

### 3. اختبار النظام

```bash
# اختبار النظام
node test-password-reset.js

# تشغيل الخادم
npm run dev
```

### 4. اختبارات يدوية مطلوبة

#### أ. اختبار البريد المسجل

1. اذهب إلى `/forgot-password`
2. أدخل بريد إلكتروني مسجل في النظام
3. تحقق من وصول البريد الإلكتروني
4. انقر على الرابط في البريد
5. تأكد من عمل صفحة إعادة تعيين كلمة المرور
6. أدخل كلمة مرور جديدة
7. تأكد من نجاح العملية

#### ب. اختبار البريد غير المسجل

1. اذهب إلى `/forgot-password`
2. أدخل بريد إلكتروني غير مسجل
3. تأكد من ظهور رسالة النجاح العامة
4. تأكد من عدم وصول أي بريد إلكتروني

#### ج. اختبار التوكن المنتهي الصلاحية

1. انتظر انتهاء صلاحية التوكن (60 دقيقة)
2. حاول استخدام الرابط
3. تأكد من ظهور رسالة الخطأ المناسبة

#### د. اختبار Rate Limiting

1. حاول طلب إعادة تعيين كلمة المرور عدة مرات
2. تأكد من ظهور رسالة الحظر بعد 5 محاولات
3. انتظر ساعة واحدة وتأكد من إعادة تفعيل الخدمة

#### ه. اختبار الموبايل

1. افتح الموقع على الهاتف المحمول
2. اختبر جميع الصفحات
3. تأكد من وضوح الإشعارات والنصوص
4. تأكد من عدم الحاجة للتمرير لرؤية الإشعارات

## استكشاف الأخطاء

### مشكلة: لا يصل البريد الإلكتروني

**الحلول**:

1. تحقق من صحة `RESEND_API_KEY`
2. تحقق من صحة `SENDER_EMAIL`
3. تحقق من مجلد Spam/Junk
4. تأكد من إعداد النطاق في Resend

### مشكلة: خطأ في قاعدة البيانات

**الحلول**:

1. تأكد من تشغيل الجداول المطلوبة:
   ```bash
   node server/db/create-password-reset-table.js
   node server/db/create-rate-limit-table.js
   ```
2. تحقق من اتصال قاعدة البيانات

### مشكلة: Rate Limiting لا يعمل

**الحلول**:

1. تحقق من إنشاء جدول `rate_limit_logs`
2. تحقق من تشغيل خدمة التنظيف الدوري

## مراقبة النظام

### سجلات النظام

- جميع العمليات مسجلة في console
- يمكن مراقبة السجلات في Render Dashboard

### إحصائيات النظام

```bash
# تشغيل اختبار النظام لعرض الإحصائيات
node test-password-reset.js
```

## الأمان

### نصائح أمنية

1. **احتفظ بمفتاح Resend سرياً**
2. **استخدم HTTPS في الإنتاج**
3. **راقب سجلات Rate Limiting**
4. **نظف التوكنات المنتهية الصلاحية بانتظام**

### مراجعة دورية

- راجع سجلات النظام أسبوعياً
- تحقق من إحصائيات Rate Limiting
- تأكد من عمل خدمة التنظيف الدوري

## الدعم

### في حالة المشاكل

1. تحقق من سجلات النظام
2. شغل اختبار النظام
3. تحقق من متغيرات البيئة
4. راجع هذا الدليل

### معلومات مفيدة

- **مدة صلاحية التوكن**: 60 دقيقة (قابلة للتخصيص)
- **حد Rate Limiting**: 5 محاولات في الساعة
- **فترة التنظيف**: كل 60 دقيقة
- **احتفاظ السجلات**: 7 أيام

---

**تاريخ الإنشاء**: ${new Date().toLocaleDateString('ar-SA')}
**آخر تحديث**: ${new Date().toLocaleDateString('ar-SA')}
